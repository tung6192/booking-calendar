<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Framgia Hanoi Coference Room</title>
    <script src='fullcalendar-3.1.0/lib/jquery.min.js'></script>
    <script src='fullcalendar-3.1.0/lib/moment.min.js'></script>
    <script src="fullcalendar-3.1.0/fullcalendar.min.js" type="text/javascript" charset="utf-8"></script>
    <script type='text/javascript' src='fullcalendar-3.1.0/gcal.js'></script>
    <script src='jbox/js/jBox.min.js'></script>
    <script src="https://unpkg.com/flatpickr"></script>
    <link rel="stylesheet" href="fullcalendar-3.1.0/fullcalendar.css">
    <link rel="stylesheet" href="jbox/css/jBox.css">
    <link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css">
</head>
<body>
<h3>Ha Noi</h3>
<h4 style="color:red;">Events that overlapping with others:</h4>

<!-- Write down overlapping events-->
<div id="info">
</div>
<h4 style="color:blue;">
    Rooms order (from left to right): Abuja, Astana, Bàn tròn, Bangkok, Cebu, CEO Room, Dhaka, DN Office, Freespace, Jakarta, Kuala Lumpur, Other, Phnompenh, Shimane, Singapore, Tokyo, Toong, Vientiane
</h4>

<!--Date picking-->
<strong>Pick a day: </strong> <input type="text" id="minicalendar">

<br>
<br>

<!--Print out calendar -->
<div id='calendar'>


</div>

<!--Show tooltip when hower an event-->
<div id="event-more-template" style="display:none;">
  When: <span id="event-when"></span><br>
  <a id="event-url" href="#">Details</a>
</div>


<script>
    var a, v, e, clr, r;

    // initiate color, each room corresponds to a color
    colors = {
        'Abuja': 'DARKORANGE',
        'Astana': 'CRIMSON',
        'Cebu': 'DARKKHAKI',
        'Bàn tròn': 'REBECCAPURPLE',
        'Bangkok': 'INDIANRED',
        'CEO Room': 'MEDIUMVIOLETRED',
        'Dhaka': 'OLIVEDRAB',
        'Phnompenh': 'DARKRED',
        'Shimane': 'MEDIUMAQUAMARINE',
        'Singapore': 'STEELBLUE',
        'Tokyo': 'ROSYBROWN',
        'Toong': 'DARKMAGENTA',
        'DN Office': 'INDIGO',
        'Freespace': 'NAVY',
        'Other': 'RED',
        'Jakarta': 'LIMEGREEN',
        'Kuala Lumpur': 'DARKORCHID',
        'Vientiane': 'TEAL',
    },
    rooms = ['Abuja','Astana','Bàn tròn','Bangkok','Cebu','CEO Room','Dhaka','DN Office','Freespace','Jakarta','Kuala Lumpur','Other','Phnompenh','Shimane','Singapore','Tokyo','Toong','Vientiane'];

    $(document).ready(function() {

        // page is now ready, initialize the calendar...
        clr = $('#calendar');
        $('#calendar').fullCalendar({
            // put your options and callbacks here
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            },
            selectable: false,
            editable: false,
            nowIndicator: true,
            defaultView: 'agendaDay',

            // get events from GG API
            googleCalendarApiKey: 'AIzaSyC94E9YH_ldRbfjiGKTkc5-7gbmNLfKzao',
            events: {
                googleCalendarId: 'a7ibdacd74oiprvqs7a7n2a1ik@group.calendar.google.com'
            },

            // render events
            eventAfterRender: function(event, element, view) {
                e = event;
                r = getRoomName(event);
                element.css('background-color', colors[r]);
                element.css('border-color', colors[r]);
                if (view.type != "month" && event.start.hasTime()) {

                    // Show bad events
                    bad_event = checkOverlap(event);
                    if (bad_event) {
                        time_txt = bad_event.start.format("dddd, MMMM Do, h:mm a") + " - " + bad_event.end.format("h:mm a");
                        $("#info").append(bad_event.title + ' - ' + time_txt + '<br>');
                    }

                    // Differentiate past events
                    element.css('margin-right', 0);
                    if (event.end < Date.now()) {
                        element.css('opacity', 0.5);
                    }

                    // positioning each event
                    pos = rooms.indexOf(r);
                    ratio = 100 / rooms.length;

                    // l - left magrin, r - right margin
                    l = pos * ratio;
                    r = 100 - l - ratio;
                    if (r < 0) r = 0;
                    element.css('left', l + '%');
                    element.css('right', r + '%');
                }

                // Create box when hover
                if (!event.tip) {
                    event.tip = new jBox('Tooltip', {
                        title: event.title,
                        content: initDialog(event),
                        attach: $(element),
                        blockScroll: true,
                        closeOnMouseleave: true,
                        adjustPosition: 'flip',
                        adjustPosition: {top: 50, right: 5, bottom: 20, left: 5},
                        repositionOnOpen: true,
                    });
                }
            },

            eventAfterAllRender: function (){
                var view = $('#calendar').fullCalendar('getView');
                if (view.type == "agendaDay") {
                    mini.setDate(
                        $('#calendar').fullCalendar('getDate').format("YYYY-MM-DD")
                    );
                }
            },

            viewRender: function(view, element) {
                $("#info").html("");
            },
        });

        // refetch events after a minute
        setInterval(function(){
            $("#info").html("");
            clr.fullCalendar('refetchEvents')
        }, 60000);


        function getRoomName(event){
            for (var i = rooms.length - 1; i >= 0; i--) {
                title = event.title.toLowerCase();
                if (title.indexOf(rooms[i].toLowerCase()) != -1) {
                    event.room = rooms[i];
                    return rooms[i];
                }
            }

            event.room = "Other";
            return "Other";
        }

        function checkOverlap(event) {  

            var start = new Date(event.start);
            var end = new Date(event.end);

            var overlap = $('#calendar').fullCalendar('clientEvents', function(ev) {
                if( ev == event)
                    return false;
                var estart = new Date(ev.start);
                var eend = new Date(ev.end);

                return (Math.round(estart)/1000 < Math.round(end)/1000 && Math.round(eend) > Math.round(start) && ev.room == event.room);
            });

            if (overlap.length){
                return event;
            }
        }

        function initDialog(event){
            time_txt = event.start.format("dddd, MMMM Do, h:mm a") + " - " + event.end.format("h:mm a");
            tpl = $("#event-more-template");
            tpl.find("#event-when").html(time_txt);
            tpl.find("#event-url").attr('href', event.url);
            return tpl.html();
        }

        mini = $("#minicalendar").flatpickr({
            onChange: function(selectedDates, dateStr, instance) {
                $('#calendar').fullCalendar('gotoDate', new Date(dateStr));
            }
        });
    });
</script>
<hr>

<!-- Footer -->
<footer>
© Framgia Vietnam 2017 - by vigov5
</footer>
</body>
</html>
